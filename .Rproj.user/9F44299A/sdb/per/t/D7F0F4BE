{
    "collab_server" : "",
    "contents" : "rm(list=ls())\nlibrary(Reumannplatz)\n\nds.two<-readRDS(\"Data_TwoLayers_clean.RDS\")\ni.season<-2 #spring\nds.two<-ds.two[[i.season]]\n\n\n######## sig test: shallow vs. deep #########\ndists<-readRDS(\"res_distance_from_shore.RDS\")\ni1<-which(dists<240) #near-shore\ni2<-which(dists>=240) #off-shore\ni.dist<-list(i1,i2)\n\ntsranges3<-matrix(c(2, 3, 3, 4, 4, Inf, 2,4, 4,Inf, 2,Inf), ncol=2, byrow=TRUE)\na<-1\nans<-vector(\"list\", 6)\nnames(ans)<-c(\"C.near\",\"C.off\",\"T.near\",\"T.off\",\"N.near\",\"N.off\")\nfor(i in c(3,1,2)){\n  for(j in 1:2){\n    x.top<-ds.two[[1]][[i]][i.dist[[j]],]\n    x.bottom<-ds.two[[2]][[i]][i.dist[[j]],]\n    sig.test<-cohtestfast(x.bottom, x.top, nsurrogs = 10000, min.scale = 2, max.scale = NULL, tsranges = tsranges3)\n    sig.test<-sig.test[-(1:2)]\n    sig.test$p.timescale<-1-sig.test$emp.rank/10000\n    sig.test$Arg<-Arg(sig.test$emp.coh)\n    ans[[a]]<-sig.test\n    a<-a+1\n  }\n}\nsaveRDS(ans,\"res_coherence_clean.RDS\")\n\n\n############ plot test: phase angle vs. freq ###################\nans<-readRDS(\"res_coherence_clean.RDS\")\n### plot\ntiff(\"Fig_test_phase_vs_freq.tif\", width=6, height=6, units=\"in\",res=300,compression = \"lzw\")\nop<-par(mfrow=c(3,2), oma=c(3,5,2,3), mar=c(2,2,1,1),mgp=c(2,0.5,0))\na<-1\nfor(f in 1:3){\n  for(j in 1:2){\n    x<-ans[[a]]\n    plot(1/x$timescales, x$Arg, ylim=c(-pi, pi), pch=20, xlab=NA, ylab=NA,cex=1.5)\n\n    par(usr=c(par(\"usr\")[1:2], c(0,1)))\n    lines(1/x$timescales, x$p.timescale,  col=\"red\")\n    lines(range(1/x$timescales), c(0.05,0.05), lty=\"dashed\", col=\"red\")\n    axis(4,col.axis=\"red\",col.lab=\"red\")\n    \n    mtext(paste0(\"(\",letters[a],\")\"), side=3, line=-2.2, adj=0.05, cex=0.9)\n    if(a==2){\n      mtext(paste0(\"p(low-freq): \",round(x$pvals[5],3)), side=1, line=-3.7, adj=0.95,cex=0.8)\n      mtext(paste0(\"p(high-freq): \",round(x$pvals[4],3)), side=1, line=-2.5, adj=0.95,cex=0.8)\n    }else{\n      mtext(paste0(\"p(low-freq): \",round(x$pvals[5],3)), side=3, line=-1.2, adj=0.95,cex=0.8)\n      mtext(paste0(\"p(high-freq): \",round(x$pvals[4],3)), side=3, line=-2.5, adj=0.95,cex=0.8)\n    }\n    a<-a+1\n  }\n}\npar(fig = c(0, 1, 0, 1), oma=c(1,3,0,0), mar = c(3, 3, 0, 0), new = TRUE)\nplot(NA, xlim=c(0,1),ylim=c(0,1), xlab=\"frequency\",ylab=\"phase angle\",\n     type = \"n\", bty = \"n\", xaxt = \"n\", yaxt = \"n\", cex.lab=1, font.lab=1)\nmtext(\"near-shore\", side=3, line=-2, adj=0.2, cex=0.9)\nmtext(\"off-shore\", side=3, line=-2, adj=0.7, cex=0.9)\nmtext(\"Chl-a\", side=2, line=4, adj=0.82, cex=0.9)\nmtext(\"temperature\", side=2, line=4, adj=0.5, cex=0.9)\nmtext(\"nitrate\", side=2, line=4, adj=0.12, cex=0.9)\nmtext(\"p-values\", side=4, line=-2, cex=0.9, col=\"red\")\npar(op)\ndev.off()\n\n\n\n\n########### Fig3: rose diagram (shallow vs. deep) ##############\nans<-readRDS(\"res_coherence_clean.RDS\")\nlibrary(circular)\ntiff(\"Fig3_rose_diagram.tif\", width=4, height=6, units=\"in\",res=300,compression = \"lzw\")\nop<-par(mfrow=c(3,2), oma=c(1,1,2,1), mar=c(2,2,1,1),mgp=c(2,0.5,0))\na<-1\nfor(f in 1:3){\n  for(j in 1:2){\n    x<-ans[[a]]\n    if(a==1){\n      rose.phase<-Arg(x$emp.coh[x$timescales<4])  #discard low frequency for chla vs chla nearshore\n    }else{rose.phase<-Arg(x$emp.coh)}\n    \n    rose.diag(circular(rose.phase), bins=16, col=\"grey\")\n    mtext(paste0(\"(\",letters[a],\")\"), side=3, line=-1.2, adj=0.05, cex=0.9)\n    a<-a+1\n  }\n}\npar(fig = c(0, 1, 0, 1), oma=c(1,1,0,0), mar = c(3, 3, 0, 0), new = TRUE)\nplot(NA, xlim=c(0,1),ylim=c(0,1), xlab=NA,ylab=NA,\n     type = \"n\", bty = \"n\", xaxt = \"n\", yaxt = \"n\", cex.lab=1.2, font.lab=2)\nmtext(\"near-shore\", side=3, line=-2, adj=0.1, cex=0.9)\nmtext(\"off-shore\", side=3, line=-2, adj=0.78, cex=0.9)\nmtext(\"Chl-a\", side=2, line=1, adj=0.82, cex=0.9)\nmtext(\"temperature\", side=2, line=1, adj=0.45, cex=0.9)\nmtext(\"nitrate\", side=2, line=1, adj=0.08, cex=0.9)\npar(op)\ndev.off()\n\n\n",
    "created" : 1522678442923.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1316318676",
    "id" : "D7F0F4BE",
    "lastKnownWriteTime" : 1522785124,
    "last_content_update" : 1522785124953,
    "path" : "D:/Git/CalCOFI/main_TwoLayers_coherence.R",
    "project_path" : "main_TwoLayers_coherence.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}